# WordPress GitOps Workflow Rules

**This file is auto-loaded for every Claude Code session working with a WordPress GitOps repository.**

---

## Critical Rules

### ⚠️ Rule 1: NEVER Create Meta Files Manually

Meta files (`meta/pages/*.json`, `meta/posts/*.json`, etc.) are **auto-generated by GitHub Actions** after successful WordPress resource creation.

```bash
# ❌ NEVER DO THIS
echo '{"post_id": 123}' > meta/pages/my-page.json
git add meta/pages/my-page.json

# ✅ CORRECT: Only add content files
git add content/pages/my-page.txt
git commit -m "Add my-page"
git push origin staging
# Meta file is created automatically after deployment
```

**Why:** Manually created meta files cause the workflow to think a page already exists in WordPress, leading to update attempts on non-existent resources (404 errors).

---

### ⚠️ Rule 2: Always Test on Staging First

```bash
# ✅ CORRECT workflow
git push origin staging     # Test first
# Verify on staging site
git checkout main
git merge staging
git push origin main        # Then production

# ❌ NEVER push directly to main without testing
git push origin main
```

**Why:** Broken shortcodes, missing images, or API errors should be caught on staging, not production.

---

### ⚠️ Rule 3: New Pages MUST Have YAML Frontmatter

Content files for new pages MUST include frontmatter with at minimum `title` and `slug`:

```txt
---
title: My New Page
slug: my-new-page
status: publish
---
[av_section]
...
[/av_section]
```

**Why:** The creation script extracts metadata from frontmatter. Missing frontmatter causes creation to fail.

---

### ⚠️ Rule 4: Existing Pages Do NOT Have Frontmatter

Pulled pages and existing pages have their metadata in the meta file. The content file contains ONLY shortcodes:

```txt
[av_section]
...
[/av_section]
```

**Why:** Frontmatter in existing page files is ignored. The meta file is the source of truth for WordPress ID.

---

### ⚠️ Rule 5: Content Must Be Enfold Shortcodes, NOT HTML

Valid content:
```
[av_section min_height='' padding='default' av_uid='av-abc123']
[av_one_full first]
[av_textblock]<p>Hello world</p>[/av_textblock]
[/av_one_full]
[/av_section]
```

Invalid content (rendered HTML):
```html
<div class="av-section">
  <div class="av-one-full">
    <div class="av-textblock"><p>Hello world</p></div>
  </div>
</div>
```

**Why:** Enfold page builder only works with shortcodes. Rendered HTML cannot be edited in the visual builder.

---

### ⚠️ Rule 6: Use Design Tokens for Colors

When creating pages, use Enfold's color set classes instead of hardcoded hex values:

```
# ✅ CORRECT - use color sets
[av_section color='main_color' ...]
[av_section color='alternate_color' ...]

# ❌ AVOID - hardcoded colors
[av_section custom_bg='#0a364d' ...]
```

Load design tokens to see the brand colors:
```bash
cat theme/design-tokens.json
```

**Why:** Color sets ensure consistency and allow site-wide color changes via design tokens.

---

### ⚠️ Rule 7: Large Changes Go Through Feature Branches

For large or potentially breaking changes:

```bash
# ✅ CORRECT - feature branch + PR
git checkout staging
git checkout -b feature/new-homepage
# Make changes...
git push origin feature/new-homepage
# Create PR targeting staging

# ❌ AVOID for large changes
git checkout staging
# Make many changes...
git push origin staging
```

**Why:** Feature branches allow review, easy rollback, and don't block other work.

---

## Quick Reference

### File Locations

| Content Type | Content File | Meta File |
|-------------|--------------|-----------|
| Pages | `content/pages/<slug>.txt` | `meta/pages/<slug>.json` |
| Posts | `content/posts/<slug>.txt` | `meta/posts/<slug>.json` |
| Portfolio | `content/portfolio/<slug>.txt` | `meta/portfolio/<slug>.json` |
| Layouts | `content/layouts/<slug>.txt` | `meta/layouts/<slug>.json` |

### Branches

| Branch | Environment | Auto-deploy |
|--------|-------------|-------------|
| `staging` | staging2.forrofederation.com | ✅ Yes |
| `main` | forrofederation.com | ✅ Yes (when enabled) |

### Content Detection Logic

| Condition | Action |
|-----------|--------|
| Content file exists, NO meta file | CREATE new in WordPress |
| Content file exists, meta file exists | UPDATE existing in WordPress |
| Meta file exists, NO content file | Orphan - should be deleted |

---

## Common Mistakes

### Mistake 1: Copying meta files with content

```bash
# ❌ WRONG - copying another page's meta
cp meta/pages/about.json meta/pages/new-page.json
```

**Fix:** Delete the meta file. Let the workflow create it.

### Mistake 2: Pulling rendered HTML

```bash
# ❌ WRONG - pulling without context=edit
curl "https://site.com/wp-json/wp/v2/pages/123" | jq -r '.content.rendered'
```

**Fix:** Always use `context=edit` with authentication:
```bash
curl -u "$USER:$PASS" "https://site.com/wp-json/wp/v2/pages/123?context=edit" | jq -r '.content.raw'
```

### Mistake 3: Editing meta files

```bash
# ❌ WRONG - changing page_id manually
jq '.page_id = 456' meta/pages/about.json > tmp && mv tmp meta/pages/about.json
```

**Fix:** Meta files should never be edited. If you need to re-link, delete and re-pull.

---

## Validation Commands

Before committing, validate:

```bash
# Check for Enfold shortcodes
grep -l '\[av_' content/pages/*.txt

# Check for rendered HTML (should return nothing)
grep -l '<div.*class="av-' content/pages/*.txt

# Check shortcode balance
for f in content/pages/*.txt; do
  opens=$(grep -c '\[av_section' "$f")
  closes=$(grep -c '\[/av_section\]' "$f")
  [[ "$opens" != "$closes" ]] && echo "Unbalanced: $f ($opens vs $closes)"
done
```

---

## Getting Help

- `/wp-status` - Check overall health
- `/wp-setup --update` - Fix common issues
- See `troubleshooting.md` for error solutions
