name: Deploy to WordPress

on:
  push:
    branches:
      - main
      - staging
    paths:
      - 'content/**'
      - 'theme/**'
  workflow_dispatch:
    inputs:
      deploy_all:
        description: 'Deploy all pages (not just changed)'
        required: false
        default: 'false'
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install jq
        run: sudo apt-get install -y jq
      
      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref_name }}" == "staging" ]]; then
            echo "url=${{ vars.STAGING_URL }}" >> $GITHUB_OUTPUT
            echo "env_name=STAGING" >> $GITHUB_OUTPUT
            echo "Deploying to STAGING"
          else
            echo "url=${{ vars.PRODUCTION_URL }}" >> $GITHUB_OUTPUT
            echo "env_name=PRODUCTION" >> $GITHUB_OUTPUT
            echo "Deploying to PRODUCTION"
          fi
      
      - name: Get changed content files
        id: changed
        run: |
          if [[ "${{ github.event.inputs.deploy_all }}" == "true" || "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]]; then
            FILES=$(find content -name "*.txt" -type f | tr '\n' ' ')
          else
            FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} -- 'content/' | grep '\.txt' | tr '\n' ' ' || echo "")
          fi
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $FILES"
      
      - name: Check for theme changes
        id: theme_changed
        run: |
          if [[ "${{ github.event.inputs.deploy_all }}" == "true" || "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]]; then
            THEME_CHANGED="true"
          else
            THEME_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} -- 'theme/' | grep -q '\.json' && echo "true" || echo "false")
          fi
          echo "changed=$THEME_CHANGED" >> $GITHUB_OUTPUT
          echo "Theme changed: $THEME_CHANGED"
      
      - name: Deploy changed content
        if: steps.changed.outputs.files != ''
        env:
          WP_USERNAME: ${{ secrets.USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
        run: |
          chmod +x scripts/deploy-content.sh
          
          echo "Deploying to ${{ steps.env.outputs.env_name }} (${{ steps.env.outputs.url }})"
          echo "========================================"
          
          FAILED=0
          for file in ${{ steps.changed.outputs.files }}; do
            if [[ -f "$file" ]]; then
              echo "----------------------------------------"
              echo "Processing: $file"
              if ! ./scripts/deploy-content.sh "$file" "${{ steps.env.outputs.url }}" "$WP_USERNAME" "$WP_APP_PASSWORD"; then
                FAILED=1
              fi
            fi
          done
          
          if [[ $FAILED -eq 1 ]]; then
            echo "Some deployments failed!"
            exit 1
          fi
          
          echo "========================================"
          echo "All deployments completed successfully!"
      
      - name: Deploy theme settings
        if: steps.theme_changed.outputs.changed == 'true'
        env:
          WP_USERNAME: ${{ secrets.USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
        run: |
          if [[ -f "theme/design-tokens.json" ]]; then
            echo "----------------------------------------"
            echo "Deploying theme settings..."
            
            # Generate Enfold settings from design tokens
            python3 scripts/generate-theme-settings.py \
              theme/design-tokens.json \
              "${{ steps.env.outputs.url }}" \
              /tmp/theme-settings.txt
            
            # Deploy theme settings via REST API
            PAYLOAD_FILE=$(mktemp)
            trap "rm -f $PAYLOAD_FILE" EXIT
            jq -n --rawfile settings /tmp/theme-settings.txt '{"settings": $settings}' > "$PAYLOAD_FILE"
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST "${{ steps.env.outputs.url }}/wp-json/enfold-gitops/v1/settings" \
              -u "$WP_USERNAME:$WP_APP_PASSWORD" \
              -H "Content-Type: application/json" \
              -d "@$PAYLOAD_FILE")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            
            if [[ "$HTTP_CODE" -ge 200 && "$HTTP_CODE" -lt 300 ]]; then
              echo "✅ Theme settings deployed successfully"
              echo "Response: $BODY"
            else
              echo "❌ Theme deployment failed (HTTP $HTTP_CODE)"
              echo "Response: $BODY"
              exit 1
            fi
          else
            echo "No theme/design-tokens.json found, skipping theme deployment"
          fi
      
      - name: No changes detected
        if: steps.changed.outputs.files == '' && steps.theme_changed.outputs.changed == 'false'
        run: echo "No content or theme files changed. Nothing to deploy."