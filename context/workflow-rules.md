# GitOps Workflow Rules for Agentic Development

Critical rules for coordinating multiple Claude Code sessions and maintaining code quality.

## üö® Golden Rules - NEVER BREAK THESE

1. **NEVER manually create meta files** - They are auto-generated by GitHub Actions
2. **NEVER push directly to main** - Always test on staging first
3. **NEVER commit large/breaking changes to staging** - Use feature branches + PRs
4. **NEVER modify files outside your assigned scope** - Stay in your lane
5. **NEVER edit auto-generated files** - Only edit source files

## Branching Strategy

```
main (production) ‚Üê staging (testing) ‚Üê feature/xxx (development)
                                      ‚Üê fix/yyy
                                      ‚Üê import/zzz
```

| Branch | Purpose | Deploys to | Can Push Directly? |
|--------|---------|------------|-------------------|
| `main` | Production code | example.com | ‚ùå NO - merge from staging only |
| `staging` | Integration testing | staging.example.com | ‚úÖ Yes (small changes) |
| `feature/*` | New features | - | ‚úÖ Yes |
| `fix/*` | Bug fixes | - | ‚úÖ Yes |
| `import/*` | Content imports | - | ‚úÖ Yes |

## Git Worktrees for Parallel Development

Worktrees allow multiple Claude Code sessions to work simultaneously without conflicts.

### Setting Up Worktrees

```bash
# From main repo directory
git worktree add Worktrees/feature-homepage feature/homepage
git worktree add Worktrees/fix-contact-form fix/contact-form
git worktree add Worktrees/import-blog-posts import/blog-posts
```

### Worktree Rules

1. **One worktree = One branch = One task**
2. **Directory name MUST match branch name**
3. **Stay in your worktree directory** - no `cd ../`
4. **Only modify files for your specific task**
5. **Create PR when done** - don't merge directly

### Example Worktree Session

```bash
# You're in: /project/Worktrees/feature-homepage
pwd  # Verify location
git branch --show-current  # Should show: feature/homepage

# Work on ONLY homepage files
edit content/pages/home.txt
git add content/pages/home.txt
git commit -m "feat(home): Update hero section"
git push origin HEAD

# Create PR via GitHub CLI
gh pr create --base staging --title "Update homepage hero"
```

## Feature Branch Workflow

### 1. Create Feature Branch

```bash
# Branch from staging, not main
git checkout staging
git pull origin staging
git checkout -b feature/new-testimonials
```

### 2. Work in Small Commits

```bash
# Atomic commits with clear messages
git add content/pages/testimonials.txt
git commit -m "feat(testimonials): Add customer success stories"

git add theme/design-tokens.json
git commit -m "style: Update testimonial section colors"
```

#### Commit Message Convention

Use conventional commits for clarity:

- `feat:` New features or pages
- `fix:` Bug fixes or corrections  
- `content:` Content updates (text, images)
- `style:` Visual changes (colors, fonts, spacing)
- `refactor:` Code improvements without changing behavior
- `docs:` Documentation updates
- `chore:` Maintenance tasks
- `test:` Test-related changes

Format: `type(scope): description`

Examples:
- `feat(home): Add video hero section`
- `fix(contact): Correct form validation`
- `content(about): Update team bios`
- `style(global): Apply new brand colors`

### 3. Push and Create PR

```bash
git push origin feature/new-testimonials
gh pr create --base staging \
  --title "Add customer testimonials page" \
  --body "- Added 5 new testimonials
- Updated color scheme for testimonial cards
- Tested on local Enfold instance"
```

### 4. Test on Staging

After PR is merged to staging:
1. Wait for deployment (2-3 minutes)
2. Check staging.example.com
3. Clear cache if needed
4. Verify all changes work

### 5. Promote to Production

```bash
git checkout main
git merge staging --no-ff
git push origin main
```

## Coordinating Multiple Sessions

When multiple Claude Code instances work on the same project:

### Communication via Git

1. **Branch names indicate intent**
   - `feature/mobile-menu` - New mobile menu
   - `fix/contact-form-validation` - Fixing form issues
   - `import/spanish-pages` - Importing translated content

2. **Commit messages provide context**
   ```
   feat(nav): Add mobile hamburger menu
   fix(contact): Validate email format
   content(es): Import Spanish translations
   ```

3. **PR descriptions explain changes**
   - What changed and why
   - Testing performed
   - Any dependencies or conflicts

### Avoiding Conflicts

1. **Scope isolation** - Each session works on different files
2. **Clear ownership** - Branch name indicates who/what
3. **Regular pulls** - Stay updated with staging
4. **Quick merges** - Don't let PRs sit too long

## Quality Gates

### Before Committing

- [ ] Syntax is valid (no broken shortcodes)
- [ ] File matches expected format
- [ ] No hardcoded URLs (use relative paths)
- [ ] No manual meta files created
- [ ] Changes are scoped to your task

### Before Creating PR

- [ ] All commits have clear messages
- [ ] Branch is up to date with staging
- [ ] Changes tested locally if possible
- [ ] PR description explains changes
- [ ] No merge conflicts

### Before Merging to Staging

- [ ] PR reviewed (or self-reviewed)
- [ ] CI checks pass
- [ ] No breaking changes
- [ ] Deployment won't affect other work

### Before Promoting to Main

- [ ] Tested thoroughly on staging
- [ ] No console errors
- [ ] Performance acceptable
- [ ] Cache cleared and retested
- [ ] Stakeholder approval (if needed)

## Meta File Management

### Auto-Generation Flow

```
content/pages/new-page.txt (with frontmatter)
    ‚Üì git push
GitHub Actions
    ‚Üì creates page in WordPress
    ‚Üì captures page ID
    ‚Üì generates meta/pages/new-page.json
    ‚Üì commits back to repo
```

### Rules

1. **New content** - Include YAML frontmatter, no meta file
2. **Existing content** - No frontmatter, has meta file
3. **Never mix** - Either frontmatter OR meta file, not both
4. **Trust the system** - Let automation handle IDs

## Common Workflows

### Single Page Update
```bash
git checkout staging
edit content/pages/about.txt
git add content/pages/about.txt
git commit -m "content(about): Update team section"
git push origin staging
```

### Multi-Page Feature
```bash
git checkout -b feature/summer-campaign
edit content/pages/summer-offers.txt
edit content/pages/summer-events.txt
edit theme/design-tokens.json
git add .
git commit -m "feat(summer): Add campaign pages and theme"
git push origin HEAD
gh pr create --base staging
```

### Emergency Fix
```bash
git checkout -b fix/broken-contact-form
edit content/pages/contact.txt
git add content/pages/contact.txt
git commit -m "fix(contact): Repair form shortcode"
git push origin HEAD
gh pr create --base staging --label urgent
```

## Error Recovery

### Accidentally Edited Wrong File
```bash
git checkout -- path/to/wrong/file.txt
```

### Committed to Wrong Branch
```bash
git reset HEAD~1  # Undo last commit
git stash         # Save changes
git checkout correct-branch
git stash pop     # Apply changes
```

### Merge Conflicts
```bash
git checkout staging
git pull origin staging
git checkout your-branch
git rebase staging  # Resolve conflicts
git push --force-with-lease origin your-branch
```

### Broken Deployment
1. Check GitHub Actions logs
2. Verify credentials still valid
3. Check meta file isn't corrupted
4. Ensure plugin is activated
5. Try manual deployment with scripts

## Summary

This workflow enables:
- ‚úÖ Multiple AI agents working in parallel
- ‚úÖ Safe testing before production
- ‚úÖ Clear ownership and communication
- ‚úÖ Automatic conflict resolution
- ‚úÖ Quality gates at each step
- ‚úÖ Fast iteration with safety nets

Remember: **The system is designed to help you. Trust the automation, follow the rules, and focus on creating great content!**